RAG 성능이 안나오는 이유는 검색기를 통해 조회된 문서가 정확하게 반환되지 않았기 때문. 주기적으로 langsmith를 통해서 검색된 문서를 주기적으로 확인하고 불필요한 문서가 지속적으로 나온다면 이를 제거할 수 있도록 검색 로직을 찾아가는 노력이 필요함.
벡터DB에서 제공하는 검색기를 사용할 수 있지만 직접 구현도 가능함.

### 검색기의 필요성
1. 정확한 정보 제공
2. 응답 시간 단축 : 효율적인 검색 알고리즘을 통해 적절한 정보를 빠르게 검색함으로써 시스템 응답 시간을 단축
3. 최적화 : 필요한 정보를 추출함으로써 불필요한 데이터 처리를 줄일 수 있음

### 동작 방식
1. 질문의 벡터화
2. 백터 유사성 비교

### Sparse Retriever & Dense Retriever

sparse는 키워드 검색 - 법률 문서 등 키워드가 중요할때. TF-IDF, BM25가 주로 사용됨. 단어의 존재 여부만을 고려하기 때문에 비용이 적다. 단순한 질문에 적합
dense는 의미 검색 - 코사인 유사도를 통해서 검색할 문서와 유사한 문서를 찾음. 의미적 처리 능력이 중요할 때 사용됨. 또한 복잡한 질문이나 자연어 쿼리에 적합

하이브리드 서치를 사용해서 할 수도 있다


### vectorStore 지원 검색기
각 백터DB에서 지원하는 검색기.
db.as_retriever() 로 객체를 생성하여 사용
search_type, search_kwargs에 매개변수 값을 넣어서 다양한 검색 옵션을 설정이 가능하다.


### Contextual Compression Retriever
조회된 문서는 llm으로 질문과 관련된 부분만 가지고 압축하여 제공하거나 아니면 임베딩 기반으로 필터링하는 방법으로 검색된 문서의 내용을 압축해서 제공하는 방법. llm을 사용하는 경우 비용과 시간이 발생한다. 전체 문서를 llm에게 전달하거나 요약해서 전달하거나 비용은 비슷하다. 다만, llm으로 한번 필터링을 통해서 질의와 무관한 텍스트를 제거하여 할루시네이션을 줄이고 생성된 결과의 품질을 올릴 수 있다.

### 앙상블 검색기(RRF 알고리즘)
여러 검색기를 결합하여 더 강력한 검색 결과를 제공하는 랭체인의 기능.
여러 검색기를 통합하여 결과를 결합함. 또한 여러 검색기가 검색한 결과를 재순위화가 가능한데 단순히 합치는 것이 아니라 순위를 매길 때 reciprocal Rank Fusion 알고리즘 (RRF)을 통해서 결과의 순위를 조정함.
하이브리드 검색을 사용하기 때문에 sparse와 dense 검색기를 적절하게 조합해서 사용하기 때문에 다양한 시나리오에서 향상된 성능을 제공 할 수 있음.
